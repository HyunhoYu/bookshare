# TODO: 책장 월 임대료 결제 기능

## 개요
책소유자(BOOK_OWNER)가 점유 중인 책장의 월 임대료를 조회하고 결제하는 기능.
책장 타입(BOOK_CASE_TYPE)별 월 임대료(MONTHLY_PRICE)를 기준으로 과금하며, 결제 기록을 DB에 저장한다.

---

## 1. 기존 테이블과의 관계

```
USERS (BOOK_OWNER)
  └── BOOK_CASE_OCCUPIED_RECORD (점유 기록)
        └── BOOK_CASE (책장)
              └── BOOK_CASE_TYPE (책장 타입: monthlyPrice)
                    └── RENTAL_PAYMENT (신규: 임대료 결제 기록)
```

### 핵심 관계
- `BOOK_CASE_OCCUPIED_RECORD`: 어떤 책소유자가 어떤 책장을 점유 중인지 (occupiedAt ~ unOccupiedAt)
- `BOOK_CASE.bookCaseTypeId` → `BOOK_CASE_TYPE.id`: 책장의 월 임대료(MONTHLY_PRICE) 결정
- `RENTAL_PAYMENT` (신규): 점유 기록 단위로 월 결제 내역 저장

---

## 2. 임대료 조회 API

### `GET /api/rental-payments/my`
책소유자가 자신이 점유 중인 책장의 임대료 정보를 조회한다.

**권한**: `@RequireRole(Role.BOOK_OWNER)`

**응답 데이터**:
```json
{
  "data": [
    {
      "bookCaseId": 1,
      "bookCaseTypeCode": "BIG",
      "locationName": "1층 A구역",
      "monthlyPrice": 50000,
      "occupiedAt": "2026-01-15T10:00:00",
      "lastPaidMonth": "2026-01",
      "nextPaymentMonth": "2026-02",
      "isPaid": false
    }
  ]
}
```

**조회 로직**:
1. JWT에서 bookOwnerId 추출
2. BOOK_CASE_OCCUPIED_RECORD에서 현재 점유 중인 책장 목록 조회 (unOccupiedAt IS NULL)
3. 각 책장의 BOOK_CASE_TYPE.MONTHLY_PRICE 조인
4. RENTAL_PAYMENT에서 해당 점유의 마지막 결제 월 조회
5. 현재 월 기준 미결제 여부 판단

### `GET /api/rental-payments/my/history`
책소유자의 전체 결제 이력을 조회한다.

**권한**: `@RequireRole(Role.BOOK_OWNER)`

### `GET /api/rental-payments` (관리자용)
전체 결제 현황 조회.

**권한**: `@RequireRole(Role.ADMIN)`

---

## 3. 임대료 결제 API

### `POST /api/rental-payments`
책소유자가 특정 책장의 월 임대료를 결제한다.

**권한**: `@RequireRole(Role.BOOK_OWNER)`

**요청**:
```json
{
  "occupiedRecordId": 1,
  "paymentMonth": "2026-02"
}
```

**결제 프로세스**:
1. 점유 기록 존재 여부 + 본인 점유인지 검증
2. 해당 월 중복 결제 여부 검증
3. BOOK_CASE → BOOK_CASE_TYPE에서 MONTHLY_PRICE 조회
4. 결제 실행 (결제 수단에 따라)
5. RENTAL_PAYMENT INSERT (결제 기록 저장)

**결제 수단 (단계적 확장)**:
- **MVP (1단계)**: 관리자가 수동 확인 후 결제 완료 처리 (오프라인 결제/계좌이체)
  - 결제 상태: `PENDING` → 관리자가 `CONFIRMED`로 변경
- **2단계**: 토스페이먼츠 결제 연동 (카드/계좌이체)
  - 기존 `TossPaymentService` 패턴 활용
  - 결제 성공 시 `paymentKey` 저장

### `PUT /api/rental-payments/{id}/confirm` (관리자용)
관리자가 결제를 확인하고 승인 처리한다 (MVP 단계).

**권한**: `@RequireRole(Role.ADMIN)`

---

## 4. DB 테이블 설계

### RENTAL_PAYMENT (임대료 결제 기록)

```sql
CREATE TABLE RENTAL_PAYMENT (
    ID                NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    OCCUPIED_RECORD_ID NUMBER        NOT NULL,
    PAYMENT_MONTH      VARCHAR2(7)   NOT NULL,  -- 'YYYY-MM' 형식
    AMOUNT             NUMBER        NOT NULL,
    PAYMENT_STATUS     VARCHAR2(20)  DEFAULT 'PENDING' NOT NULL,
                                      -- PENDING, CONFIRMED, CANCELLED
    PAYMENT_KEY        VARCHAR2(200),  -- 토스페이먼츠 결제키 (2단계)
    PAID_AT            TIMESTAMP,      -- 실제 결제 확인 시각
    CREATED_AT         TIMESTAMP     DEFAULT SYSTIMESTAMP NOT NULL,

    CONSTRAINT FK_RP_OCCUPIED_RECORD
        FOREIGN KEY (OCCUPIED_RECORD_ID)
        REFERENCES BOOK_CASE_OCCUPIED_RECORD (ID),

    CONSTRAINT UQ_RP_RECORD_MONTH
        UNIQUE (OCCUPIED_RECORD_ID, PAYMENT_MONTH),

    CONSTRAINT CK_RP_STATUS
        CHECK (PAYMENT_STATUS IN ('PENDING', 'CONFIRMED', 'CANCELLED'))
);
```

**컬럼 설명**:
| 컬럼 | 타입 | 설명 |
|---|---|---|
| ID | NUMBER (IDENTITY) | PK |
| OCCUPIED_RECORD_ID | NUMBER (FK) | BOOK_CASE_OCCUPIED_RECORD.ID 참조 |
| PAYMENT_MONTH | VARCHAR2(7) | 결제 대상 월 (예: '2026-02') |
| AMOUNT | NUMBER | 결제 금액 (결제 시점의 MONTHLY_PRICE) |
| PAYMENT_STATUS | VARCHAR2(20) | PENDING / CONFIRMED / CANCELLED |
| PAYMENT_KEY | VARCHAR2(200) | 토스페이먼츠 결제키 (2단계, nullable) |
| PAID_AT | TIMESTAMP | 결제 확인 시각 (CONFIRMED 시 설정) |
| CREATED_AT | TIMESTAMP | 결제 요청 시각 |

**제약조건**:
- `UQ_RP_RECORD_MONTH`: 동일 점유 기록 + 동일 월 중복 결제 방지
- `FK_RP_OCCUPIED_RECORD`: 점유 기록 참조 무결성
- `CK_RP_STATUS`: 결제 상태 값 제한

**Identity 시퀀스**: INSERT 후 selectKey CURRVAL 패턴 적용 (프로젝트 표준)

---

## 5. 백엔드 구현 파일 목록

### 새로 생성할 파일
```
src/main/java/my/
├── api/rental/
│   └── RentalPaymentController.java
├── domain/rental/
│   ├── RentalPaymentVO.java
│   ├── RentalPaymentMapper.java
│   ├── dto/
│   │   ├── RentalPaymentRequestDto.java
│   │   └── RentalPaymentInfoDto.java      -- 조회 응답용
│   └── service/
│       ├── RentalPaymentService.java
│       └── RentalPaymentServiceImpl.java
src/main/resources/mybatis/mapper/
└── RentalPaymentMapper.xml
src/test/java/my/domain/rental/
└── RentalPaymentServiceTest.java
```

### API 엔드포인트 목록

| Method | Path | 역할 | 권한 |
|---|---|---|---|
| GET | `/api/rental-payments/my` | 내 책장 임대료 현황 조회 | BOOK_OWNER |
| GET | `/api/rental-payments/my/history` | 내 결제 이력 조회 | BOOK_OWNER |
| POST | `/api/rental-payments` | 임대료 결제 요청 | BOOK_OWNER |
| GET | `/api/rental-payments` | 전체 결제 현황 (관리자) | ADMIN |
| PUT | `/api/rental-payments/{id}/confirm` | 결제 확인 처리 (관리자) | ADMIN |

---

## 6. 프론트엔드 화면

### 책소유자 포털 (추후 개발)
- **내 책장 임대료** 페이지
  - 점유 중인 책장 목록 + 월 임대료 표시
  - 당월 결제 상태 (미결제 / 결제완료)
  - [결제하기] 버튼 → 결제 요청

### 관리자 포털
- **임대료 결제 관리** 페이지 (`/admin/rental-payments`)
  - 전체 결제 현황 테이블 (Ant Design Table)
  - 상태 필터 (PENDING / CONFIRMED / CANCELLED)
  - PENDING 건 선택 → [확인 처리] 버튼

### 필요 React Query 훅
```typescript
// hooks/queries.ts
useMyRentalPayments()         // GET /api/rental-payments/my
useMyRentalHistory()          // GET /api/rental-payments/my/history
useCreateRentalPayment()      // POST /api/rental-payments (mutation)
useRentalPayments()           // GET /api/rental-payments (admin)
useConfirmRentalPayment()     // PUT /api/rental-payments/:id/confirm (mutation)
```

### 필요 타입 정의
```typescript
// types/rental.ts
interface RentalPaymentInfo {
  bookCaseId: number;
  bookCaseTypeCode: string;
  locationName: string;
  monthlyPrice: number;
  occupiedAt: string;
  lastPaidMonth: string | null;
  nextPaymentMonth: string;
  isPaid: boolean;
}

interface RentalPayment {
  id: number;
  occupiedRecordId: number;
  paymentMonth: string;
  amount: number;
  paymentStatus: 'PENDING' | 'CONFIRMED' | 'CANCELLED';
  paymentKey: string | null;
  paidAt: string | null;
  createdAt: string;
}
```

---

## 7. 구현 우선순위

### Phase 1 (MVP)
1. RENTAL_PAYMENT 테이블 생성
2. RentalPaymentMapper + XML (INSERT, SELECT)
3. RentalPaymentService (결제 요청, 조회)
4. RentalPaymentController (API 엔드포인트)
5. 테스트 작성
6. 관리자 결제 확인 API (confirm)
7. 관리자 포털 결제 관리 페이지

### Phase 2 (결제 연동)
1. 토스페이먼츠 결제 API 연동 (기존 TossPaymentService 확장)
2. 책소유자 포털 개발 (별도 프론트엔드)
3. 자동 과금/알림 기능 (미결제 시)

---

## 8. 검증 사항

- 점유 해제(unOccupyProcess) 시 미결제 임대료 확인 로직 추가 여부 검토
- 점유 시작 월의 일할 계산 여부 (정책 결정 필요)
- 장기 미결제 시 자동 점유 해제 여부 (정책 결정 필요)
- 임대료 변경 시 기존 점유자 적용 시점 (정책 결정 필요)

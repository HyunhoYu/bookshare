# 토스페이먼츠 송금 연동 구현 설명

---

## 1. 이 기능이 뭔가

BookShare는 공유서점 플랫폼이다. 시민(BookOwner)이 책장을 임대해서 본인 책을 진열하고, 고객이 책을 사면 판매대금이 발생한다.

**정산**이란, 쌓여있는 판매대금을 BookOwner의 은행 계좌로 실제로 보내주는 것이다.

기존에는 "정산 실행" 버튼을 눌러도 DB에 기록만 남기고 실제 돈은 보내지 않았다.
이번 작업으로 **토스페이먼츠 송금 API를 호출하여 실제로 BookOwner 계좌에 돈을 입금**하도록 만들었다.

---

## 2. 사용자 화면에서의 흐름

```
관리자(ADMIN) 또는 직원(EMPLOYEE)이 관리 화면에서:

1. "미정산 내역 조회" → 아직 송금하지 않은 판매기록 목록이 보임
2. 정산할 판매기록을 선택 (체크박스 등)
3. "정산 실행" 버튼 클릭
4. 서버에서:
   - 판매금액 합산
   - 비율에 따라 소유주 몫 계산
   - 토스페이먼츠를 통해 소유주 계좌로 송금
5. 화면에 결과 표시:
   - 총 판매액: 95,000원
   - 소유주 지급액: 66,500원 (실제 송금된 금액)
   - 매장 수수료: 28,500원
   - 송금 상태: COMPLETED
```

---

## 3. 우리 서버의 API (POST /api/settlements)

관리 화면(프론트엔드)이 호출하는 우리 서버의 API.

### 요청

```
POST /api/settlements
Authorization: Bearer {JWT토큰}
```

```json
{
  "bookOwnerId": 1,
  "saleRecordIds": [10, 11, 12]
}
```

| 파라미터 | 설명 |
|----------|------|
| `bookOwnerId` | 돈을 받을 책 소유주의 ID |
| `saleRecordIds` | 정산할 판매기록 ID 목록 (미정산 상태여야 함) |

### 성공 응답

```json
{
  "id": 1,
  "bookOwnerId": 1,
  "settledAt": "2026-02-11T13:00:00.000+00:00",
  "totalAmount": 95000,
  "ownerAmount": 66500,
  "storeAmount": 28500,
  "payoutKey": "payout_abc123",
  "transferStatus": "COMPLETED"
}
```

| 필드 | 설명 |
|------|------|
| `totalAmount` | 선택한 판매기록들의 판매가 합계 |
| `ownerAmount` | 비율 적용 후 소유주에게 실제 송금한 금액 |
| `storeAmount` | 매장이 가져가는 수수료 (totalAmount - ownerAmount) |
| `payoutKey` | 토스페이먼츠가 발급한 송금 추적 키 (나중에 송금 내역 조회 시 사용) |
| `transferStatus` | 송금 결과 (COMPLETED = 성공) |

### 실패 응답 예시

```json
// 정산 금액이 0원일 때
{ "message": "정산 금액이 0원입니다", "status": 400 }

// 토스 송금이 실패했을 때
{ "message": "정산 송금 실패", "status": 500 }
```

---

## 4. 우리 서버가 호출하는 외부 API (토스페이먼츠)

우리 서버의 `settle()`이 내부적으로 토스페이먼츠의 송금 API를 호출한다.

### 호출 대상

```
POST https://api.tosspayments.com/v1/payouts
Authorization: Basic {Base64(시크릿키 + ":")}
Content-Type: application/json
```

### 우리가 보내는 인자

```json
{
  "bankCode": "06",
  "accountNumber": "123-456-789",
  "amount": 66500,
  "holderName": "홍길동"
}
```

| 인자 | 설명 | 값의 출처 |
|------|------|-----------|
| `bankCode` | 은행 2자리 코드 | BANK_ACCOUNT 테이블의 BANK_CODE (없으면 BankCodeResolver가 은행명으로 변환) |
| `accountNumber` | 계좌번호 | BANK_ACCOUNT 테이블의 ACCOUNT_NUMBER |
| `amount` | 송금 금액 (원) | 판매 시점 비율로 계산한 ownerAmount |
| `holderName` | 예금주명 | BookOwner의 이름 (USERS 테이블의 NAME) |

### 토스가 돌려주는 응답

```json
{
  "payoutKey": "payout_abc123",
  "status": "COMPLETED",
  "bankCode": "06",
  "accountNumber": "123-456-789",
  "amount": 66500,
  "failureCode": null,
  "failureMessage": null
}
```

| 필드 | 설명 |
|------|------|
| `payoutKey` | 토스가 발급한 고유 송금 키 (우리 DB에 저장하여 추적용) |
| `status` | 송금 결과 |
| `failureCode` / `failureMessage` | 실패 시 원인 정보 |

### 인증 방식

토스 시크릿 키를 Base64로 인코딩하여 Basic Auth 헤더로 전송한다.
시크릿 키는 `application.yml`의 `toss.payments.secret-key`에 설정되어 있고, 실제 운영 시에는 환경변수 `TOSS_SECRET_KEY`로 주입한다.

---

## 5. 금액 계산 방식

### 비율 적용 규칙

- 관리자가 정산비율을 설정한다 (예: 소유주 70%, 매장 30%)
- 책이 **판매되는 시점**에 그때의 비율 ID가 판매기록에 저장된다 (`RATIO_ID`)
- 정산할 때는 각 판매기록의 `RATIO_ID`로 **판매 당시의 비율**을 적용한다

이렇게 하는 이유: 나중에 비율이 80:20으로 바뀌더라도, 70:30 시절에 팔린 책은 70:30으로 정산해야 공정하기 때문.

### 계산 예시

비율 70:30에서 3권 판매 후 정산:

```
책A (30,000원): 소유주 = FLOOR(30000 × 70 / 100) = 21,000원
책B (40,000원): 소유주 = FLOOR(40000 × 70 / 100) = 28,000원
책C (25,000원): 소유주 = FLOOR(25000 × 70 / 100) = 17,500원

totalAmount  = 95,000원  (판매가 합계)
ownerAmount  = 66,500원  (소유주 지급액 = 실제 송금액)
storeAmount  = 28,500원  (매장 수수료 = 95000 - 66500)
```

FLOOR는 소수점 이하를 버린다 (예: 23,333.3원 → 23,333원). 1원 미만은 매장 쪽으로 귀속.

---

## 6. 전체 처리 흐름 (settle 메서드)

```
프론트엔드 → POST /api/settlements 호출
                     │
                     ▼
            ┌─ 검증 단계 ──────────────────┐
            │ 1. 판매기록 목록이 비어있지 않은지 │
            │ 2. BookOwner가 존재하는지       │
            │ 3. 계좌 정보가 등록되어 있는지    │
            │ 4. 판매기록이 해당 BookOwner 소유인지│
            │ 5. 이미 정산된 기록이 아닌지      │
            └──────────────────────────────┘
                     │ 검증 통과
                     ▼
            ┌─ 금액 계산 ──────────────────┐
            │ DB에서 판매가 합산 + 비율 적용    │
            │ → totalAmount, ownerAmount 산출│
            │ → 0원이면 에러                  │
            └──────────────────────────────┘
                     │
                     ▼
            ┌─ 계좌 정보 준비 ─────────────┐
            │ bankCode 조회                 │
            │ (없으면 BankCodeResolver 폴백)  │
            │ 예금주명(holderName) 조회       │
            └──────────────────────────────┘
                     │
                     ▼
            ┌─ 토스페이먼츠 송금 ────────────┐
            │ POST /v1/payouts 호출         │
            │ → 성공: payoutKey, status 수신  │
            │ → 실패: 예외 → 전체 롤백        │
            └──────────────────────────────┘
                     │ 성공
                     ▼
            ┌─ DB 저장 ───────────────────┐
            │ BOOK_OWNER_SETTLEMENT INSERT  │
            │ (금액 + payoutKey + status)    │
            │ BOOK_SALE_RECORD 업데이트      │
            │ (settlement_id 링크)          │
            └──────────────────────────────┘
                     │
                     ▼
            프론트엔드에 SettlementVO 반환
```

### 트랜잭션 처리

전체가 `@Transactional`로 묶여 있다:

| 시나리오 | 결과 |
|----------|------|
| 토스 송금 실패 | 예외 발생 → DB 변경 없음 (롤백) |
| 토스 성공 → DB 저장 실패 | 롤백. payoutKey는 로그에 남아 수동 확인 가능 |
| 모두 성공 | 정상 커밋. 돈도 보내지고 DB에도 기록됨 |

---

## 7. 변경한 파일 목록과 각 파일의 역할

### DB 스키마 (SQL 2건)

| 파일 | 변경 내용 |
|------|-----------|
| `alter_bank_account.sql` | BANK_ACCOUNT 테이블에 `BANK_CODE` 컬럼 추가 (토스 API용 은행 코드) |
| `alter_settlement.sql` | BOOK_OWNER_SETTLEMENT 테이블에 `TOTAL_AMOUNT`, `OWNER_AMOUNT`, `STORE_AMOUNT`, `PAYOUT_KEY`, `TRANSFER_STATUS` 컬럼 추가 |

### 신규 파일 (2건)

| 파일 | 역할 |
|------|------|
| `src/.../common/util/BankCodeResolver.java` | 은행명("국민은행") → 은행 코드("06") 변환. BANK_CODE가 DB에 없을 때 폴백용 |
| `src/test/.../config/TestTossPaymentService.java` | 테스트용 스텁. 실제 토스 API 대신 항상 성공 응답을 반환. `@Primary`로 테스트 시 자동 주입됨 |

### 수정 파일 (8건)

| 파일 | 변경 내용 |
|------|-----------|
| `BankAccountVO.java` | `bankCode` 필드 추가 |
| `BankAccountMapper.xml` | resultMap, INSERT에 `BANK_CODE` 매핑 추가 |
| `SettlementVO.java` | `totalAmount`, `ownerAmount`, `storeAmount`, `payoutKey`, `transferStatus` 필드 추가 |
| `SettlementMapper.xml` | resultMap, INSERT에 5개 컬럼 매핑 추가 |
| `BookSoldRecordMapper.java` | `sumAmountsByIds()` 메서드 추가 |
| `BookSoldRecordMapper.xml` | `sumAmountsByIds` SQL 쿼리 추가 (판매가 합산 + 비율 적용) |
| `ErrorCode.java` | `SETTLEMENT_AMOUNT_ZERO` 에러코드 추가 |
| `SettlementServiceImpl.java` | **핵심**: 금액 계산 → 토스 송금 → 결과 저장 로직 추가. `TossPaymentService` DI 추가 |

---

## 8. 설정값

`application.yml`에 이미 설정되어 있음:

```yaml
toss:
  payments:
    secret-key: ${TOSS_SECRET_KEY:test_sk_no_key_set}
    base-url: https://api.tosspayments.com/v1
```

- `TOSS_SECRET_KEY` 환경변수: 실제 운영 시 토스페이먼츠 대시보드에서 발급받은 시크릿 키를 넣어야 한다
- 환경변수가 없으면 `test_sk_no_key_set`이 기본값으로 들어가고, 당연히 실제 송금은 실패한다

---

## 9. 테스트

기존 140개 테스트 전부 통과.

테스트 환경에서는 `TestTossPaymentService`(`@Primary`)가 실제 `TossPaymentServiceImpl` 대신 주입되어,
토스 API를 호출하지 않고 항상 성공 응답을 반환한다.
`src/test/` 하위에 있으므로 프로덕션 빌드(jar)에는 포함되지 않는다.

# BookShare 설계 및 정책

> 이 문서는 시스템의 비즈니스 정책과 설계 결정을 사람이 읽기 쉽게 정리한 것입니다.

---

## 1. 시스템 개요

공유서점 플랫폼. 시민(책소유주)이 서점의 책장을 임대하여 본인 책을 판매한다.

**등장 인물**
- **Admin**: 서점 관리자. 정산 실행, 임대료 납부 확인 등 관리 업무
- **BookOwner (책소유주)**: 책장을 임대하고 책을 판매하는 사람
- **Customer (고객)**: 책을 구매하는 사람

**돈의 흐름**
- 고객 → 서점: 책 구매 대금
- 서점 → 책소유주: 판매 정산금 (비율에 따라 분배)
- 책소유주 → 서점: 책장 임대료 (매월)

---

## 2. 임대료 정책

### 임대료 생성
- 책소유주가 책장을 점유(입거)하면, **만기일까지의 월별 임대료가 한꺼번에 생성**된다
- 예: 2월 15일 입거, 6월 만기 → 2월~6월분 5건이 UNPAID 상태로 한 번에 생성
- 입거월은 **일할 계산** (남은 일수만큼만 부과)
- 이후 월은 정상 월 임대료

### 납부
- 납부 기한: **매월 말일**
- 현재(MVP): 책소유주가 계좌이체 → 관리자가 입금 확인 후 수동 PAID 처리
- 추후: 토스페이먼츠 온라인 결제 + Webhook 자동 처리 예정

### 보증금
- 보증금 = 월 임대료와 동일 금액
- 입거 시 보증금 + 입거월 일할 임대료를 납부해야 점유 시작
- 보증금은 별도 DEPOSIT 테이블에서 관리 (BCOR 1:1 참조)
- 연체 임대료 발생 시 보증금에서 자동 공제 (매월 1일 05:00 스케줄러)

---

## 3. 정산 정책

### 정산 대상
- 판매된 책의 대금을 책소유주에게 지급하는 것
- 판매 시점의 정산비율(예: 책소유주 70% / 서점 30%)로 계산

### 정산 실행 시점
- **자동**: 매월 1일 06:00 스케줄러가 전월 미정산 판매기록을 일괄 정산
- **수동**: Admin이 언제든 개별/배치 정산 가능

### 정산 흐름
1. 미정산 판매기록 확인
2. 금액 계산 (판매 시점 비율 적용)
3. 책소유주 몫(ownerAmount) 전액 송금 (토스페이먼츠)
4. 정산 기록 저장

> 정산에서는 임대료 상계를 수행하지 않는다. 연체 임대료 회수는 보증금 스케줄러가 담당한다.

---

## 4. 보증금 기반 연체 관리 정책

### 핵심 원칙
> 연체 임대료는 **보증금에서 자동 공제**한다. 판매 정산금에서는 공제하지 않는다.
> 보증금이 소진되면 **중지**, 이후에도 연체가 계속되면 **강제 퇴거** 처리한다.

### 왜 이렇게 하는가
- 판매 정산금은 매월 자동으로 책소유주에게 입금되므로 쌓이지 않음 → 상계 재원으로 부적합
- 보증금은 입거 시 이미 납부한 금액이므로 연체 시 즉시 차감 가능
- 정산과 임대료 관리를 분리하여 각 로직을 단순하게 유지

### 연체 판정 기준
- `TARGET_MONTH < 스케줄러 실행 월`이면 연체
- 예: 3월 1일 스케줄러 실행 시
  - 2월분 (TARGET_MONTH='2026-02', 기한 2월 28일) → **연체 → 공제 대상**
  - 3월분 (TARGET_MONTH='2026-03', 기한 3월 31일) → **기한 전 → 공제 안 함**

### 공제 순서
- FIFO: 오래된 연체 임대료부터 공제 (TARGET_MONTH 오름차순)
- 예: 1월분, 2월분 둘 다 연체 → 1월분부터 공제

### 공제 한도
- 보증금 잔액(DEPOSIT.REMAINING_AMOUNT) 한도까지만 공제
- 보증금보다 연체 임대료가 많으면 → 보증금 전액 공제, 나머지 연체분은 UNPAID 유지

### 부분 공제
- 임대료 하나를 전부 공제할 수 없으면 일부만 공제 가능
- 예: 임대료 50,000원인데 잔여 보증금이 30,000원 → 30,000원만 공제, 20,000원은 UNPAID 유지

### 단계적 제재

| 단계 | 조건 | 처리 |
|------|------|------|
| 1. 보증금 공제 | 연체 발생 | 보증금에서 FIFO 자동 공제 |
| 2. 보증금 소진 | REMAINING_AMOUNT = 0 | DEPOSIT.STATUS → DEPLETED, 로그 경고 |
| 3. 중지 | 소진 후 추가 연체 발생 | BCOR.SUSPENDED_AT 설정 → 정산 제외 |
| 4. 강제 퇴거 | 다음 스케줄러 시 여전히 SUSPENDED | unOccupyProcess 실행 (책 회수 전환) |

- 중지 해제 조건: 미납 임대료 전액 납부 + 보증금 재납부
- 알림: 현재 로그만 남김 (추후 알림 인프라 구축 시 문자/알림 발송)

### 예시

**케이스 1: 보증금으로 연체 공제**
```
보증금 잔액: 50,000원
연체 임대료: 2월분 50,000원

→ 보증금에서 50,000원 공제
→ 보증금 잔액: 0원 → STATUS=DEPLETED
```

**케이스 2: 보증금 부분 공제**
```
보증금 잔액: 30,000원
연체 임대료: 1월분 50,000원

→ 보증금에서 30,000원 공제 (잔액 한도)
→ 보증금 잔액: 0원 → STATUS=DEPLETED
→ 1월분 임대료 잔액: 20,000원 (UNPAID 유지)
```

**케이스 3: 보증금 소진 후 추가 연체 → 중지**
```
보증금: 이미 DEPLETED (잔액 0원)
연체 임대료: 3월분 50,000원 (새로 연체)

→ 공제 불가
→ BCOR.SUSPENDED_AT = 현재 시각 → 중지 상태
→ 정산 스케줄러에서 제외됨 (정산금 수령 불가)
```

**케이스 4: 중지 후 미해소 → 강제 퇴거**
```
BCOR: SUSPENDED 상태 (이전 스케줄러에서 중지 처리됨)
다음 스케줄러 실행 시 여전히 SUSPENDED

→ 강제 퇴거 (unOccupyProcess 실행)
→ 미판매 책: NORMAL → SHOULD_BE_RETRIEVED
→ 로그로 강제 퇴거 기록
```

---

## 5. 월간 타임라인

```
매월 초 ────────────────────────────── 매월 말
  │                                      │
  │  1일 05:00  보증금 스케줄러            │  말일
  │  - 연체 임대료 보증금 공제             │  임대료 납부 기한
  │  - 보증금 소진 시 중지/강제퇴거        │
  │                                      │
  │  1일 06:00  정산 스케줄러              │
  │  - 전월 판매분 정산                   │
  │  - ownerAmount 전액 송금              │
  │                                      │
  │         (책 판매 발생)                │
  │         (임대료 납부)                 │
```

- 1일 05:00: 보증금 스케줄러가 **연체 임대료를 보증금에서 공제** + 중지/강제퇴거 처리
- 1일 06:00: 정산 스케줄러가 전월 판매분을 정산하고 **전액 송금** (임대료 공제 없음)
- 1일~말일: 책 판매 발생, 책소유주가 당월 임대료 납부
- 말일: 당월 임대료 납부 기한 → 안 내면 다음 달 1일에 보증금에서 공제됨

---

## 6. 조기 퇴거 정책

- 조기 퇴거는 언제든 가능
- 퇴거 시 UNPAID 상태인 임대료를 **모두 납부**해야 퇴거 처리 완료
- 납부 완료 후 unOccupyProcess 실행 (책장 반납 + 미판매 책 회수 대기 전환)

---

## 7. 계약 연장 정책

- 연장은 언제든 가능
- 만기일을 새로운 날짜로 업데이트
- 기존 만기일 이후 ~ 새 만기일까지 추가 임대료 레코드 생성

---

## 변경 이력

| 날짜 | 내용 |
|------|------|
| 2026-02-20 | 최초 작성 |
| 2026-02-20 | 상계 정책 변경: 전체 UNPAID → 연체분만 공제 |
| 2026-02-20 | 정산에서 임대료 상계 제거 → 보증금 기반 연체 관리로 전환 |
| 2026-02-20 | 보증금 별도 테이블 분리, 단계적 제재(중지/강제퇴거) 정책 추가 |
| 2026-02-20 | BCOR: DEPOSIT/DEPOSIT_STATUS 제거, SUSPENDED_AT 추가 |
